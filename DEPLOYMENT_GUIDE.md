# Database Deployment Guide

## Overview

This project uses **Drizzle ORM's automatic migration system** for database schema management. There are TWO workflows depending on your environment:

### Development Workflow (Local)
- **Direct schema sync** using `npm run db:push`
- No migration files needed
- Fast iteration and testing

### Production Workflow (Deployment)
- **Git-tracked migrations** generated by Drizzle
- Migration files committed to version control
- Safe, auditable production deployments

---

## When to Use Each Approach

### Use `db:push` For:
- ‚úÖ Local development (always)
- ‚úÖ Syncing existing production database with schema changes
- ‚úÖ Emergency fixes (missing tables)
- ‚úÖ When production already has tables

### Use Migrations (`drizzle-kit generate/migrate`) For:
- ‚úÖ New greenfield deployments
- ‚úÖ After establishing a migration baseline
- ‚úÖ Incremental changes on a clean migration history

**For Current Production**: Use `db:push --force` (see PRODUCTION_FIX.md)

---

## üîß Development: Fast Iteration

When developing locally, use Drizzle's push command for instant schema synchronization:

```bash
# 1. Modify your schema
# Edit shared/schema.ts

# 2. Sync to database
npm run db:push

# If you encounter conflicts or errors
npm run db:push --force
```

### What `db:push` Does:
- Reads your `shared/schema.ts`
- Compares with your database
- Applies changes directly (no migration files)
- Perfect for rapid development

### ‚ö†Ô∏è NEVER MANUALLY WRITE SQL MIGRATIONS
Drizzle auto-generates migrations from your TypeScript schema. Manual SQL is error-prone and breaks the migration system.

---

## üöÄ Production: Safe Deployments

When you're ready to deploy schema changes to production:

### Step 1: Generate Migrations

```bash
# Generate migration files from your schema
drizzle-kit generate
```

This creates SQL migration files in the `./migrations/` directory:
```
migrations/
‚îú‚îÄ‚îÄ 0000_initial_schema.sql
‚îú‚îÄ‚îÄ 0001_add_menu_groups.sql
‚îú‚îÄ‚îÄ meta/
    ‚îú‚îÄ‚îÄ _journal.json
    ‚îî‚îÄ‚îÄ 0000_snapshot.json
```

### Step 2: Review Generated Migrations

Check the generated SQL files to ensure they're correct:

```bash
# View the latest migration
cat migrations/0001_*.sql
```

Drizzle generates:
- `CREATE TABLE` statements
- `ALTER TABLE` changes  
- Index creation
- All based on your schema.ts changes

### Step 3: Commit to Git

```bash
git add migrations/
git commit -m "Add database migration for menu groups feature"
git push origin main
```

### Step 4: Deploy to Production

```bash
# 1. Pull latest code (includes migrations)
git pull origin main

# 2. Run migrations
drizzle-kit migrate

# 3. Restart application
npm run start
```

---

## üìã Complete Workflow Example

### Scenario: Adding Menu Groups Feature

**1. Modify Schema (Development)**

```typescript
// shared/schema.ts
export const menuGroups = pgTable("menu_groups", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  restaurantId: varchar("restaurant_id").notNull().references(() => restaurants.id),
  groupName: text("group_name").notNull(),
  displayOrder: integer("display_order").default(0),
  createdAt: timestamp("created_at").defaultNow(),
});
```

**2. Test Locally**

```bash
# Sync schema to local database
npm run db:push

# Test the changes
npm run dev
```

**3. Generate Production Migration**

```bash
# Generate migration files
drizzle-kit generate

# Output:
# ‚úî Migrations generated in ./migrations/0001_add_menu_groups.sql
```

**4. Review and Commit**

```bash
# Review the generated SQL
cat migrations/0001_*.sql

# Commit to Git
git add migrations/
git commit -m "Add menu groups tables"
git push origin main
```

**5. Deploy to Production**

```bash
# SSH into production server
# Pull latest code
git pull origin main

# Apply migrations
drizzle-kit migrate

# Restart application
pm2 restart app  # or your restart command
```

---

## üîç Migration System Details

### How Drizzle Tracks Migrations

Drizzle creates a `__drizzle_migrations` table in your database:

```sql
SELECT * FROM __drizzle_migrations;
```

This table records:
- Which migrations have been applied
- When they were applied
- Hash verification for integrity

### Migration Files Structure

```
migrations/
‚îú‚îÄ‚îÄ 0000_initial_schema.sql       # First migration (all base tables)
‚îú‚îÄ‚îÄ 0001_add_menu_groups.sql      # Second migration (menu groups feature)
‚îú‚îÄ‚îÄ 0002_add_payment_methods.sql  # Third migration (payment features)
‚îî‚îÄ‚îÄ meta/
    ‚îú‚îÄ‚îÄ _journal.json              # Migration history
    ‚îú‚îÄ‚îÄ 0000_snapshot.json         # Schema snapshot for migration 0000
    ‚îî‚îÄ‚îÄ 0001_snapshot.json         # Schema snapshot for migration 0001
```

### Why Snapshots Matter

- Drizzle creates snapshots of your schema for each migration
- Used to calculate diffs for future migrations
- Ensures migrations are reproducible
- **Never edit these manually**

---

## üõ°Ô∏è Safety Features

### Drizzle's Built-in Protections

1. **Hash Verification**: Ensures migrations haven't been tampered with
2. **Automatic Ordering**: Migrations run in correct sequence
3. **Idempotency**: Safe to run `drizzle-kit migrate` multiple times
4. **Transaction Safety**: Each migration runs in a transaction (rollback on failure)

### Pre-Production Checklist

Before deploying migrations to production:

- [ ] Migrations tested in staging environment
- [ ] Schema changes reviewed by team
- [ ] Database backup created
- [ ] Rollback plan prepared
- [ ] Downtime window scheduled (if needed)

---

## üìä Common Commands

### Development

```bash
# Sync schema to local database
npm run db:push

# Force sync (resolve conflicts)
npm run db:push --force

# Check schema differences
drizzle-kit check
```

### Production

```bash
# Generate migration files
drizzle-kit generate

# Apply migrations to database
drizzle-kit migrate

# Check migration status
drizzle-kit status
```

### Database Inspection

```bash
# Open Drizzle Studio (GUI for database)
drizzle-kit studio

# View database schema
drizzle-kit introspect
```

---

## üêõ Troubleshooting

### "Migration already applied" Error

The migration is already in the database. This is safe to ignore.

```bash
# Check what's been applied
drizzle-kit status
```

### "Schema drift detected" Warning

Your database schema doesn't match your `shared/schema.ts`:

```bash
# In development - force sync
npm run db:push --force

# In production - generate and apply migration
drizzle-kit generate
drizzle-kit migrate
```

### Migration Fails in Production

1. Check the error message in the migration output
2. Review the generated SQL in `migrations/0xxx_*.sql`
3. Test the migration in a staging environment
4. If needed, fix the schema and regenerate:

```bash
# Fix shared/schema.ts
# Regenerate (will create new migration)
drizzle-kit generate
```

### Rollback a Migration

Drizzle doesn't have automatic rollbacks. To rollback:

**Option 1: Database Restore (Recommended)**
```bash
# Restore from backup before migration
pg_restore -d your_database backup.dump
```

**Option 2: Manual Revert**
1. Identify what the migration changed
2. Manually write inverse SQL
3. Execute against database
4. Update migration tracking table

---

## üîê Production Best Practices

### 1. Always Test in Staging

```bash
# In staging environment
git pull origin main
drizzle-kit migrate
# Test thoroughly
```

### 2. Create Database Backups

```bash
# Before running migrations in production
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 3. Use Staging Environment

Never run untested migrations directly in production:
- Development ‚Üí Staging ‚Üí Production

### 4. Monitor Migration Execution

```bash
# Run migrations with logging
drizzle-kit migrate --verbose
```

### 5. Schedule Maintenance Windows

For large migrations:
- Notify users of maintenance
- Schedule during low-traffic periods
- Have rollback plan ready

---

## üìö Current Production Issue

### Menu Groups Tables Missing

**Problem**: Production database is missing `menu_groups` and `menu_group_items` tables

**Solution**: Use `db:push` (NOT migrations)

```bash
# On production server
npm run db:push --force
```

**Why not use migrations?** 
Production already has 17 of the 19 tables. The generated migration tries to create ALL tables and will fail with "relation already exists" errors.

**See**: `PRODUCTION_FIX.md` for detailed fix instructions

---

## üéØ Quick Reference

| Task | Command | Environment |
|------|---------|-------------|
| Modify schema | Edit `shared/schema.ts` | All |
| Sync schema (dev) | `npm run db:push` | Development |
| Generate migrations | `drizzle-kit generate` | Development |
| Apply migrations | `drizzle-kit migrate` | Production |
| Check migration status | `drizzle-kit status` | All |
| Open database GUI | `drizzle-kit studio` | Development |
| View schema diff | `drizzle-kit check` | All |

---

## ‚ö†Ô∏è Critical Rules

1. **NEVER manually edit migration files** - They're auto-generated and hash-verified
2. **NEVER manually write SQL migrations** - Use Drizzle's generator
3. **ALWAYS test in staging first** - Don't surprise production
4. **ALWAYS backup before migrations** - Safety first
5. **NEVER change existing ID column types** - This breaks everything
6. **ALWAYS commit migrations to Git** - Required for deployment

---

## Summary

**Development Flow**:
```
Edit schema ‚Üí npm run db:push ‚Üí Test
```

**Production Flow**:
```
drizzle-kit generate ‚Üí Review ‚Üí Commit ‚Üí Deploy ‚Üí drizzle-kit migrate
```

This workflow gives you:
- ‚úÖ Fast development iteration
- ‚úÖ Git-tracked production migrations
- ‚úÖ Automatic SQL generation (no manual SQL)
- ‚úÖ Hash verification and safety
- ‚úÖ Audit trail of all schema changes

**Remember**: Drizzle generates migrations FROM your TypeScript schema. Your source of truth is `shared/schema.ts`, not SQL files.
